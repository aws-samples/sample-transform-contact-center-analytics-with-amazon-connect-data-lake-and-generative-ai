AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Connect Datalake Workshop
Parameters:
  GlueLocalDatabaseName:
    Type: String
    Description: Glue Local Database Name
    Default: connect-datalake-local

Resources:

  #######################
  # QuickSight DataSource
  #######################
  QuickSightDataSourceConnectCLDataLake:
    Type: "AWS::QuickSight::DataSource"
    Properties:
      DataSourceId: !Sub "${AWS::StackName}-ConnectCLDataLake"
      Name: !Sub "${AWS::StackName}-ConnectCLDataLake"
      AwsAccountId: !Ref AWS::AccountId
      Type: "ATHENA"
      DataSourceParameters:
        AthenaParameters:
          WorkGroup: "primary"

  #######################
  # QuickSight DataSet
  #######################
  QuickSightDataSetCLCtrWithAttributes:
    Type: "AWS::QuickSight::DataSet"
    Properties:
      DataSetId: ContactLensQS-Connect-Contact-Records-With-Contact-Lens
      Name: ContactLensQS - Connect Contact Records With Contact Lens
      AwsAccountId: !Ref AWS::AccountId
      PhysicalTableMap:
        a7046ace-e9bb-454f-871b-2ac57eae9dca:
          RelationalTable:
            DataSourceArn: !GetAtt QuickSightDataSourceConnectCLDataLake.Arn
            Catalog: "AwsDataCatalog"
            Schema: !Sub "${GlueLocalDatabaseName}" 
            Name: "contact_lens_conversational_analytics_categories_qs_cl_dataset"
            InputColumns:
              -
                Name: "contact_id"
                Type: "STRING"
              -
                Name: "category"
                Type: "STRING"
        d910c411-c204-4833-9285-89bc1311941d:
          RelationalTable:
            DataSourceArn: !GetAtt QuickSightDataSourceConnectCLDataLake.Arn
            Catalog: "AwsDataCatalog"
            Schema: !Sub "${GlueLocalDatabaseName}" 
            Name: "contact_record_qs_cl_dataset"
            InputColumns:
              -
                Name: "instance_id"
                Type: "STRING"
              -
                Name: "aws_account_id"
                Type: "STRING"
              -
                Name: "contact_id"
                Type: "STRING"
              -
                Name: "initial_contact_id"
                Type: "STRING"
              -
                Name: "previous_contact_id"
                Type: "STRING"
              -
                Name: "related_contact_id"
                Type: "STRING"
              -
                Name: "next_contact_id"
                Type: "STRING"
              -
                Name: "channel"
                Type: "STRING"
              -
                Name: "initiation_method"
                Type: "STRING"
              -
                Name: "initiation_timestamp"
                Type: "DATETIME"
              -
                Name: "connected_to_system_timestamp"
                Type: "DATETIME"
              -
                Name: "last_update_timestamp"
                Type: "DATETIME"
              -
                Name: "scheduled_timestamp"
                Type: "DATETIME"
              -
                Name: "transfer_completed_timestamp"
                Type: "DATETIME"
              -
                Name: "disconnect_timestamp"
                Type: "DATETIME"
              -
                Name: "disconnect_reason"
                Type: "STRING"
              -
                Name: "queue_duration_ms"
                Type: "INTEGER"
              -
                Name: "queue_dequeue_timestamp"
                Type: "DATETIME"
              -
                Name: "queue_enqueue_timestamp"
                Type: "DATETIME"
              -
                Name: "queue_name"
                Type: "STRING"
              -
                Name: "queue_arn"
                Type: "STRING"
              -
                Name: "queue_id"
                Type: "STRING"
              -
                Name: "agent_connection_attempts"
                Type: "INTEGER"
              -
                Name: "agent_connected_to_agent_timestamp"
                Type: "DATETIME"
              -
                Name: "agent_interaction_duration_ms"
                Type: "INTEGER"
              -
                Name: "agent_customer_hold_duration_ms"
                Type: "INTEGER"
              -
                Name: "agent_number_of_holds"
                Type: "INTEGER"
              -
                Name: "agent_longest_hold_duration_ms"
                Type: "INTEGER"
              -
                Name: "agent_after_contact_work_end_timestamp"
                Type: "DATETIME"
              -
                Name: "agent_after_contact_work_duration_ms"
                Type: "INTEGER"
              -
                Name: "agent_after_contact_work_start_timestamp"
                Type: "DATETIME"
              -
                Name: "attributes"
                Type: "STRING"
              -
                Name: "agent_username"
                Type: "STRING"
              -
                Name: "agent_arn"
                Type: "STRING"
              -
                Name: "agent_id"
                Type: "STRING"
              -
                Name: "instance_arn"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_1_name"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_1_arn"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_1_id"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_2_name"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_2_arn"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_2_id"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_3_name"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_3_arn"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_3_id"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_4_name"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_4_arn"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_4_id"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_5_name"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_5_arn"
                Type: "STRING"
              -
                Name: "agent_hierarchy_groups_level_5_id"
                Type: "STRING"
              -
                Name: "agent_routing_profile_name"
                Type: "STRING"
              -
                Name: "agent_routing_profile_arn"
                Type: "STRING"
              -
                Name: "agent_routing_profile_id"
                Type: "STRING"
              -
                Name: "aws_contact_trace_record_format_version"
                Type: "STRING"
              -
                Name: "campaign_id"
                Type: "STRING"
              -
                Name: "customer_endpoint_type"
                Type: "STRING"
              -
                Name: "customer_endpoint_address"
                Type: "STRING"
              -
                Name: "transferred_endpoint_type"
                Type: "STRING"
              -
                Name: "transferred_endpoint_address"
                Type: "STRING"
              -
                Name: "system_endpoint_type"
                Type: "STRING"
              -
                Name: "system_endpoint_address"
                Type: "STRING"
              -
                Name: "recording_deletion_reason"
                Type: "STRING"
              -
                Name: "recording_location"
                Type: "STRING"
              -
                Name: "recording_status"
                Type: "STRING"
              -
                Name: "recording_type"
                Type: "STRING"
              -
                Name: "answering_machine_detection_status"
                Type: "STRING"
              -
                Name: "voice_id_result_authentication_result"
                Type: "STRING"
              -
                Name: "voice_id_result_fraud_detection_watch_list_id"
                Type: "STRING"
              -
                Name: "voice_id_result_speaker_id"
                Type: "STRING"
              -
                Name: "voice_id_result_fraud_detection_result"
                Type: "STRING"
              -
                Name: "voice_id_result_fraud_detection_fraudster_id"
                Type: "STRING"
              -
                Name: "external_third_party_interaction_duration_ms"
                Type: "INTEGER"
              -
                Name: "voice_id_result_authentication_minimum_speech_ms"
                Type: "INTEGER"
              -
                Name: "voice_id_result_authentication_score"
                Type: "INTEGER"
              -
                Name: "voice_id_result_authentication_score_threshold"
                Type: "INTEGER"
              -
                Name: "voice_id_result_fraud_detection_risk_score_known_fraudster"
                Type: "INTEGER"
              -
                Name: "voice_id_result_fraud_detection_risk_score_synthetic_speech"
                Type: "INTEGER"
              -
                Name: "voice_id_result_fraud_detection_risk_score_voice_spoofing"
                Type: "INTEGER"
              -
                Name: "voice_id_result_fraud_detection_score_threshold"
                Type: "INTEGER"
              -
                Name: "agent_pause_duration_ms"
                Type: "INTEGER"
              -
                Name: "voice_id_result_speaker_enrolled"
                Type: "BOOLEAN"
              -
                Name: "voice_id_result_speaker_opted_out"
                Type: "BOOLEAN"
              -
                Name: "tags_references_items"
                Type: "STRING"
              -
                Name: "contact_details"
                Type: "STRING"
              -
                Name: "contact_evaluations"
                Type: "STRING"
              -
                Name: "data_lake_last_processed_timestamp"
                Type: "DATETIME"
              -
                Name: "agent_device_platform_name"
                Type: "STRING"
              -
                Name: "agent_device_platform_version"
                Type: "STRING"
              -
                Name: "agent_device_operating_system"
                Type: "STRING"
              -
                Name: "agent_capabilities_video"
                Type: "STRING"
              -
                Name: "customer_device_platform_name"
                Type: "STRING"
              -
                Name: "customer_device_platform_version"
                Type: "STRING"
              -
                Name: "customer_device_operating_system"
                Type: "STRING"
              -
                Name: "customer_capabilities_video"
                Type: "STRING"
              -
                Name: "disconnect_details_potential_disconnect_issue"
                Type: "STRING"
              -
                Name: "disconnect_details_telemetry_inferred_reason"
                Type: "STRING"
              -
                Name: "task_template_arn"
                Type: "STRING"
              -
                Name: "task_template_name"
                Type: "STRING"
              -
                Name: "last_resumed_timestamp"
                Type: "DATETIME"
              -
                Name: "last_paused_timestamp"
                Type: "DATETIME"
              -
                Name: "customer_voice_activity_greeting_start_timestamp"
                Type: "DATETIME"
              -
                Name: "customer_voice_activity_greeting_end_timestamp"
                Type: "DATETIME"
              -
                Name: "total_pause_duration_ms"
                Type: "INTEGER"
              -
                Name: "total_pause_count"
                Type: "INTEGER"
              -
                Name: "contact_routing_queue_priority"
                Type: "INTEGER"
              -
                Name: "contact_routing_queue_time_adjustment_ms"
                Type: "INTEGER"
              -
                Name: "quality_metrics_agent_reported_issue"
                Type: "STRING"
              -
                Name: "quality_metrics_agent_audio"
                Type: "STRING"
              -
                Name: "quality_metrics_customer_audio"
                Type: "STRING"
              -
                Name: "segment_attributes"
                Type: "STRING"
              -
                Name: "queue_duration_min"
                Type: "DECIMAL"
              -
                Name: "agent_interaction_duration_min"
                Type: "DECIMAL"
              -
                Name: "agent_customer_hold_duration_min"
                Type: "DECIMAL"
              -
                Name: "agent_longest_hold_duration_min"
                Type: "DECIMAL"
              -
                Name: "agent_after_contact_work_duration_min"
                Type: "DECIMAL"
              -
                Name: "external_third_party_interaction_duration_min"
                Type: "DECIMAL"
              -
                Name: "voice_id_result_authentication_minimum_speech_min"
                Type: "DECIMAL"
              -
                Name: "agent_pause_duration_min"
                Type: "DECIMAL"
              -
                Name: "total_pause_duration_min"
                Type: "DECIMAL"
              -
                Name: "contact_routing_queue_time_adjustment_min"
                Type: "DECIMAL"
              -
                Name: "agent_connected_to_agent_duration_ms"
                Type: "INTEGER"
              -
                Name: "total_duration_ms"
                Type: "INTEGER"
              -
                Name: "agent_connected_to_agent_duration_min"
                Type: "DECIMAL"
              -
                Name: "total_duration_min"
                Type: "DECIMAL"
        fa33a226-f6c7-46cc-9d11-2602192794a5:
          RelationalTable:
            DataSourceArn: !GetAtt QuickSightDataSourceConnectCLDataLake.Arn
            Catalog: "AwsDataCatalog"
            Schema: !Sub "${GlueLocalDatabaseName}" 
            Name: "contact_lens_conversational_analytics_qs_cl_dataset"
            InputColumns:
              -
                Name: "instance_id"
                Type: "STRING"
              -
                Name: "aws_account_id"
                Type: "STRING"
              -
                Name: "version"
                Type: "STRING"
              -
                Name: "instance_arn"
                Type: "STRING"
              -
                Name: "contact_id"
                Type: "STRING"
              -
                Name: "channel"
                Type: "STRING"
              -
                Name: "language_locale"
                Type: "STRING"
              -
                Name: "feature"
                Type: "STRING"
              -
                Name: "disconnect_timestamp"
                Type: "DATETIME"
              -
                Name: "greeting_time_agent_ms"
                Type: "INTEGER"
              -
                Name: "non_talk_time_total_ms"
                Type: "INTEGER"
              -
                Name: "talk_time_total_ms"
                Type: "INTEGER"
              -
                Name: "talk_time_agent_ms"
                Type: "INTEGER"
              -
                Name: "talk_time_customer_ms"
                Type: "INTEGER"
              -
                Name: "total_conversation_duration_ms"
                Type: "INTEGER"
              -
                Name: "talk_speed_agent_wpm"
                Type: "DECIMAL"
              -
                Name: "talk_speed_customer_wpm"
                Type: "DECIMAL"
              -
                Name: "interruptions_time_total_ms"
                Type: "INTEGER"
              -
                Name: "interruptions_time_agent_ms"
                Type: "INTEGER"
              -
                Name: "interruptions_time_customer_ms"
                Type: "INTEGER"
              -
                Name: "interruptions_total_count"
                Type: "INTEGER"
              -
                Name: "interruptions_agent_count"
                Type: "INTEGER"
              -
                Name: "interruptions_customer_count"
                Type: "INTEGER"
              -
                Name: "sentiment_overall_score_agent"
                Type: "DECIMAL"
              -
                Name: "sentiment_overall_score_customer"
                Type: "DECIMAL"
              -
                Name: "sentiment_interaction_score_customer_with_agent"
                Type: "DECIMAL"
              -
                Name: "sentiment_interaction_score_customer_without_agent"
                Type: "DECIMAL"
              -
                Name: "sentiment_end_score_agent"
                Type: "DECIMAL"
              -
                Name: "sentiment_end_score_customer"
                Type: "DECIMAL"
              -
                Name: "response_time_average_agent_ms"
                Type: "DECIMAL"
              -
                Name: "response_time_average_customer_ms"
                Type: "INTEGER"
              -
                Name: "response_time_maximum_agent_ms"
                Type: "INTEGER"
              -
                Name: "response_time_maximum_customer_ms"
                Type: "INTEGER"
              -
                Name: "data_lake_last_processed_timestamp"
                Type: "DATETIME"
              -
                Name: "greeting_time_agent_min"
                Type: "DECIMAL"
              -
                Name: "non_talk_time_total_min"
                Type: "DECIMAL"
              -
                Name: "talk_time_total_min"
                Type: "DECIMAL"
              -
                Name: "talk_time_agent_min"
                Type: "DECIMAL"
              -
                Name: "talk_time_customer_min"
                Type: "DECIMAL"
              -
                Name: "total_conversation_duration_min"
                Type: "DECIMAL"
              -
                Name: "interruptions_time_total_min"
                Type: "DECIMAL"
              -
                Name: "interruptions_time_agent_min"
                Type: "DECIMAL"
              -
                Name: "interruptions_time_customer_min"
                Type: "DECIMAL"
              -
                Name: "response_time_average_agent_min"
                Type: "DECIMAL"
              -
                Name: "response_time_average_customer_min"
                Type: "DECIMAL"
              -
                Name: "response_time_maximum_agent_min"
                Type: "DECIMAL"
              -
                Name: "response_time_maximum_customer_min"
                Type: "DECIMAL"

      LogicalTableMap:
        10c104d1-b0ef-4151-a60a-237a741b2ce2:
          Alias: "Intermediate Table"
          Source:
            JoinInstruction:
              LeftOperand: "36f06e3f-47a4-4cef-9047-75396ae2e31d"
              RightOperand: "92c6c6cb-fe33-4506-a560-4b8787554f87"
              LeftJoinKeyProperties: 
                UniqueKey: true
              Type: "LEFT"
              OnClause: "{contact_id} = {contact_id[contact_lens_conversational_analytics_qs_cl_dataset]}"
        36f06e3f-47a4-4cef-9047-75396ae2e31d:
          Alias: "contact_record_qs_cl_dataset"
          Source:
            PhysicalTableId: "d910c411-c204-4833-9285-89bc1311941d"
        9270291c-ded4-4e9d-b191-ad909ba9c1c9:
          Alias: "Intermediate Table (2)"
          DataTransforms:
            -
              ProjectOperation:
                  ProjectedColumns:
                    - "instance_id"
                    - "contact_id"
                    - "channel"
                    - "initiation_method"
                    - "initiation_timestamp"
                    - "disconnect_reason"
                    - "queue_name"
                    - "agent_number_of_holds"
                    - "agent_username"
                    - "agent_routing_profile_name"
                    - "customer_endpoint_address"
                    - "system_endpoint_address"
                    - "queue_duration_min"
                    - "agent_interaction_duration_min"
                    - "agent_customer_hold_duration_min"
                    - "agent_after_contact_work_duration_min"
                    - "total_duration_min"
                    - "talk_speed_agent_wpm"
                    - "sentiment_overall_score_agent"
                    - "sentiment_overall_score_customer"
                    - "non_talk_time_total_min"
                    - "talk_time_agent_min"
                    - "talk_time_customer_min"
                    - "total_conversation_duration_min"
                    - "category"

          Source:
            JoinInstruction:
              LeftOperand: "10c104d1-b0ef-4151-a60a-237a741b2ce2"
              RightOperand: "dd5231cb-934c-4d25-8541-e73259e31d4a"
              Type: "LEFT"
              LeftJoinKeyProperties: 
                UniqueKey: true
              OnClause: "{contact_id[contact_lens_conversational_analytics_qs_cl_dataset]} = {contact_id[contact_lens_conversational_analytics_categories_qs_cl_dataset]}"
        92c6c6cb-fe33-4506-a560-4b8787554f87:
          Alias: "contact_lens_conversational_analytics_qs_cl_dataset"
          DataTransforms:
            -
              RenameColumnOperation:
                ColumnName: "instance_id"
                NewColumnName: "instance_id[contact_lens_conversational_analytics_qs_cl_dataset]"
            -
              RenameColumnOperation:
                ColumnName: "aws_account_id"
                NewColumnName: "aws_account_id[contact_lens_conversational_analytics_qs_cl_dataset]"
            -
              RenameColumnOperation:
                ColumnName: "instance_arn"
                NewColumnName: "instance_arn[contact_lens_conversational_analytics_qs_cl_dataset]"
            -
              RenameColumnOperation:
                ColumnName: "contact_id"
                NewColumnName: "contact_id[contact_lens_conversational_analytics_qs_cl_dataset]"
            -
              RenameColumnOperation:
                ColumnName: "channel"
                NewColumnName: "channel[contact_lens_conversational_analytics_qs_cl_dataset]"
            -
              RenameColumnOperation:
                ColumnName: "disconnect_timestamp"
                NewColumnName: "disconnect_timestamp[contact_lens_conversational_analytics_qs_cl_dataset]"
            -
              RenameColumnOperation:
                ColumnName: "data_lake_last_processed_timestamp"
                NewColumnName: "data_lake_last_processed_timestamp[contact_lens_conversational_analytics_qs_cl_dataset]"
          Source:
            PhysicalTableId: "fa33a226-f6c7-46cc-9d11-2602192794a5"
        dd5231cb-934c-4d25-8541-e73259e31d4a:
          Alias: "contact_lens_conversational_analytics_categories_qs_cl_dataset"
          DataTransforms:
            -
              RenameColumnOperation:
                ColumnName: "contact_id"
                NewColumnName: "contact_id[contact_lens_conversational_analytics_categories_qs_cl_dataset]"
          Source:
            PhysicalTableId: "a7046ace-e9bb-454f-871b-2ac57eae9dca"
      ImportMode: "DIRECT_QUERY"
      FieldFolders: {}

  #######################
  # QuickSight Analysis
  #######################
  QuickSightAnalysisCL:
    Type: AWS::QuickSight::Analysis
    Properties:
      AnalysisId: ContactLensQS-Connect-Contact-Lens-Analysis
      Name: ContactLensQS Connect Contact Lens Analysis
      AwsAccountId: !Ref AWS::AccountId
      SourceEntity:
        SourceTemplate:
          DataSetReferences:
            -   
              DataSetArn: !GetAtt QuickSightDataSetCLCtrWithAttributes.Arn
              DataSetPlaceholder:  "ContactLensQS - Connect Contact Records With Contact Lens"
          Arn: "arn:aws:quicksight:us-west-2:533267107881:template/ContactLensQS-533267107881-Connect-Contact-Lens-Analysis-Template"

  #######################
  # QuickSight Template
  #######################
  QuickSightTemplateCL:
    Type: "AWS::QuickSight::Template"
    Properties:
      TemplateId: ContactLensQS-Connect-Contact-Lens-Analysis-Template
      Name: ContactLensQS Connect Contact Lens Analysis Template
      AwsAccountId: !Ref AWS::AccountId
      VersionDescription: "1"
      SourceEntity:
        SourceAnalysis:
          DataSetReferences:
            -   
              DataSetArn: !GetAtt QuickSightDataSetCLCtrWithAttributes.Arn
              DataSetPlaceholder: "ContactLensQS - Connect Contact Records With Contact Lens"
          Arn: !GetAtt QuickSightAnalysisCL.Arn

  #######################
  # QuickSight Dashboard
  #######################
  QuickSightDashboardCL:
    Type: "AWS::QuickSight::Dashboard"
    Properties:
      DashboardId: !Sub "${AWS::StackName}-CLDashboard"
      Name: !Sub "${AWS::StackName}-CLDashboard"
      AwsAccountId: !Ref AWS::AccountId
      VersionDescription: "1"
      DashboardPublishOptions:
        AdHocFilteringOption:
          AvailabilityStatus: "DISABLED"
        ExportToCSVOption:
          AvailabilityStatus: "ENABLED"
        SheetControlsOption:
          VisibilityState: "EXPANDED"
      SourceEntity:
        SourceTemplate:
          DataSetReferences:
            -   
              DataSetArn: !GetAtt QuickSightDataSetCLCtrWithAttributes.Arn
              DataSetPlaceholder: "ContactLensQS - Connect Contact Records With Contact Lens"
          Arn: !GetAtt QuickSightTemplateCL.Arn 

Outputs:
    QuickSightDashboardCLOutput:
        Description: Click to see the deployed dashboard. Please do not forget to share the dashboard 
        Value: !Sub 'https://${AWS::Region}.quicksight.aws.amazon.com/sn/dashboards/${AWS::StackName}-CLDashboard'
